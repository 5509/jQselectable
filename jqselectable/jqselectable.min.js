/*!
 * jQselectable
 *
 * @version      3.1
 * @author       nori (norimania@gmail.com)
 * @copyright    5509 (http://5509.me/)
 * @license      The MIT License
 * @link         https://github.com/5509/jQselectable
 *
 * 2012-07-24 12:52
 */
(function(d,e,f,c){var i={};var b=function(k,j){this.namespace="jQselectable";if(!(this instanceof b)){return new b(k,j)}this.init(k,j)};b.prototype={init:function(l,k){var j=this,k=j.conf=d.extend({style:"selectable",showDuration:150,hideDuration:150,show:"fadeIn",hide:"fadeOut",height:"auto",top:0,left:0,opacity:0.9},k);j.elem=l;j.$elem=d(l);j.$body=d("body");j.$document=d(f);j.state=false;j.map={};j.selected=c;j.selected_id=c;j.has_no_maxheight=typeof f.body.style.maxHeight;j.id=j.elem.id||"jqs_"+parseInt(Math.random()*1000);i[j.id]=j;j.attr={id:j.id,klass:j.elem.className};j.style=/simple/.test(k.style)?"sBox":"sctble";j._build();j._eventify()},_map:function(){var j=this;j.$option=j.$elem.find("option");h(j.$option,function(l,k){var m=k.value;j.map[m.length?m:"nodata"]={elem:k,text:k.textContent||k.innerText}})},_build:function(){var k=this,l=k.conf,o=k.$elem.val(),p=k.id,m=c,n=k.$body,j=k.$elem;o=(o&&o.length)?o:"nodata";k._map();k.$view=k._view(k._escapeHtml(k.map[o].text)).addClass(k.style).addClass(k.attr.klass);k.$list=k._createList().css({position:"absolute"});j.hide().after(k.$view);n.append(k.$list);k.list_height=k.$list[0].offsetHeight;m=k.selected_id;k.selected=f.getElementById(p+"_"+m);k.$list.hide()},_view:function(k){var j=this;return d(['<a id="'+j.id+'_dammy"','href="javascript:void(0)"','class="sctble_display"','data-id="'+j.id+'"',">",'<span data-id="'+j.id+'">',k,"</span>","</a>"].join(""))},_setPosition:function(){var l=this,n=l.conf,o=l.$view,m=l.$list,j=c,q=o.offset(),k=g(),p=a();if(p/2<q.top-k){j=q.top-l.list_height+n.top-5}else{j=q.top+o.height()*1.3+n.top}m.css({top:j,left:q.left+n.left})},_addSelected:function(k){var j=this;j.selected=k;k.className="selected"},_removeSelected:function(){var j=this,k=j.selected;if(!k){return}k.className=""},_addItem:function(k,l){var j=this;h(l,function(o,n){var q=n.value||"nodata",r=j._escapeHtml(j.map[q].text),m=n.className,p=n.selected;if(p){j.selected_id=q}k=k+(n.disabled?"<span>":['<a href="#'+r+'"','id="'+j.id+"_"+q+'"','data-value="'+q+'"',(p?'class="selected"':""),">"].join(""));k=k+r;k=k+(n.disabled?"</span>":"</a>");if(m&&/br/.test(m)){k=k+"<br>"}});if(!j.selected_id){j.selected_id=l[0].value}return k},_createList:function(){var m=this,n=m.conf,k=c,q=m.id+"_mat",o="sctble_mat "+m.attr.klass,p='<div id="'+q+'" class="'+o+'">',j=(n.height==="auto")?"auto":n.height+"px",l=m.$elem;if(m.has_no_maxheight){k="height: "+j+"; overflow-y: scroll;"}else{k="max-height: "+j+";"}p=p+'<div class="body" style="'+k+'">';m.has_group=l.find("optgroup").length;if(m.has_group){m.list_klass="sctble optgroup";p=p+(function(){var s="<dl>",r=l.find("optgroup");h(r,function(t,v){var u=v.getElementsByTagName("option");s=s+("<dt>"+v.label+"</dt><dd>");s=m._addItem(s,u);s=s+"</dd>"});s=s+"</dl>";return s}())}else{if(n.style==="selectable"){m.list_klass="sctble nooptgroup"}else{m.list_klass="sBox nooptgroup"}p=p+(function(){var r="";r=m._addItem(r,m.$option);return r}())}p=p+"</div></div>";return d(p).addClass(m.list_klass)},_eventify:function(){var k=this,j=k.$elem,m=k.$view,l=k.$list;m.bind("click",function(){if(k.disabled){return}j.trigger("jQselectable.click")});l.delegate("a","click",function(o){var n=this;o.preventDefault();j.trigger("jQselectable.change",{value:n.getAttribute("data-value"),anchor:n})});j.bind("jQselectable.click",function(n){k._show()});j.bind("jQselectable.change",function(n,o){k._change(o.value);k._removeSelected();k._addSelected(o.anchor);k.$view.focus()})},_show:function(){var k=this,m=k.conf,l=k.$list,o=k.$view,j=c,q=c,p=c,n=c;k._setPosition();k.state=true;if(m.show==="slideDown"){j=g();q=a();p=o.offset();n=q/2<(p.top-j);if(n){l.css({top:p.top+m.top-5});l.animate({height:"toggle",top:parseInt(l.css("top"))-k.list_height},{easing:"swing",duration:m.showDuration}).css({opacity:m.opacity})}else{l.stop(true,true).slideDown(m.showDuration).css({opacity:m.opacity})}}else{if(m.show==="fadeIn"){l.css({display:"block",opacity:0}).stop(true,true).fadeTo(m.showDuration,m.opacity)}else{l.show().css({opacity:m.opacity})}}setTimeout(function(){if(k.selected){k.selected.focus()}},isNaN(m.showDuration)?(function(){var r=m.showDuration;return(/slow/.test(r))?610:(/fast/.test(r))?210:410}()):m.showDuration+10)},_hide:function(j){var k=this,m=k.conf,l=k.$list;if(!k.state){return}k.state=false;switch(m.hide){case"slideUp":l.stop(true,true).slideUp(m.hideDuration);break;case"fadeOut":l.stop(true,true).fadeOut(m.hideDuration);break;default:l.hide()}if(!j){return}setTimeout(function(){k.$view.focus()},isNaN(m.showDuration)?(function(){var n=m.showDuration;return(/slow/.test(n))?610:(/fast/.test(n))?210:410}()):m.hideDuration+10)},_change:function(k){var j=this;j.$view.find("span").text(j.map[k].text);j.$elem.val(k)},_callAPI:function(l,k){var j=this;if(typeof j[l]!=="function"){throw new Error(l+" does not exist of "+j.namespace+" methods.")}else{if(/^_/.test(l)&&typeof j[l]==="function"){throw new Error("Method begins with an underscore are not exposed.")}}return j[l](k)},_escapeHtml:function(j){return d("<div></div>").text(j).html()},refresh:function(){var j=this;j.destroy();j._build();j._eventify();j.$elem.trigger("jQselectable.refresh")},disable:function(){var j=this;j.disabled=true;j.$view.addClass("disabled");j.$elem.trigger("jQselectable.disable")},enable:function(){var j=this;j.disabled=false;j.$view.removeClass("disabled");j.$elem.trigger("jQselectable.enable")},destroy:function(){var j=this;j.map={};j.$view.remove();j.$list.remove();j.$elem.show();j.$elem.trigger("jQselectable.destroy")}};function h(k,n){var m=0,j=k.length;for(;m<j;m=m+1){n(m,k[m])}}function g(){return f.documentElement.scrollTop||f.body.scrollTop}function a(){return f.documentElement.clientHeight||f.body.clientHeight}d(f).bind({"click.jQselectable":function(j){if(!j.target){return}var k=j.target,l=k.getAttribute("data-id");if(l&&l in i){j.stopPropagation();d.each(i,function(m,n){if(m===l){return}n._hide()});return}d.each(i,function(m,n){n._hide()})},"keyup.jQselectable":function(j){if(j.keyCode!==27){return}d.each(i,function(k,l){l._hide(true)})}});d.fn.jQselectable=function(k,j){if(!this.length){throw new Error("There is no element")}if(this.length===1){var l=this.data("jQselectable");if(l){return l._callAPI(k,j)}else{if(typeof k==="string"){return}l=b(this,k);this.data("jQselectable",l);return this}}else{d.each(this,function(){b(this,k)})}}}(jQuery,this,this.document));
